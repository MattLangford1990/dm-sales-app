<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DM Brands">
    <title>DM Brands - Trade Show Capture</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8f6f3;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --plum: #7B4B6A;
            --plum-light: #9a6488;
            --plum-pale: #f3e8ef;
            --teal: #4EB8A9;
            --teal-light: #6bc9bc;
            --teal-pale: #e8f7f5;
            --border: #e0ddd8;
            --success: #4EB8A9;
            --error: #c44536;
            --shadow: 0 4px 24px rgba(0,0,0,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; }
        .app-container { height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: var(--bg-secondary); padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .logo-container { display: flex; align-items: center; gap: 12px; }
        .logo-circle { width: 48px; height: 48px; background: #8B7082; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-family: 'DM Sans', sans-serif; font-weight: 400; font-size: 16px; letter-spacing: -0.5px; }
        .logo-text { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 500; color: var(--plum); }
        .logo-text span { font-weight: 400; color: var(--text-secondary); font-size: 13px; display: block; margin-top: -2px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .capture-count { background: var(--plum-pale); color: var(--plum); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .btn-icon { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .btn-icon:active { transform: scale(0.95); background: var(--bg-primary); }
        .btn-icon svg { width: 20px; height: 20px; color: var(--text-secondary); }
        .main-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 24px; }
        .form-card { background: var(--bg-secondary); border-radius: 20px; box-shadow: var(--shadow); max-width: 800px; margin: 0 auto; overflow: hidden; }
        .form-header { background: linear-gradient(135deg, var(--plum) 0%, var(--plum-light) 100%); color: white; padding: 32px; text-align: center; }
        .form-header h1 { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 500; margin-bottom: 8px; }
        .form-header p { opacity: 0.9; font-size: 15px; }
        .form-body { padding: 28px; }
        .form-section { margin-bottom: 28px; }
        .section-title { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 500; color: var(--plum); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid var(--plum-pale); display: flex; align-items: center; gap: 10px; }
        .section-title svg { width: 18px; height: 18px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .form-row.single { grid-template-columns: 1fr; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group label .required { color: var(--error); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px; font-size: 16px; font-family: 'DM Sans', sans-serif; border: 2px solid var(--border); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); transition: all 0.2s; -webkit-appearance: none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--teal); background: var(--bg-secondary); box-shadow: 0 0 0 4px var(--teal-pale); }
        .form-group select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; background-size: 18px; padding-right: 44px; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .brand-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .brand-checkbox { position: relative; }
        .brand-checkbox input { position: absolute; opacity: 0; width: 0; height: 0; }
        .brand-checkbox label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 14px 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; min-height: 70px; text-transform: none; letter-spacing: 0; }
        .brand-checkbox label .brand-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .brand-checkbox input:checked + label { background: var(--teal-pale); border-color: var(--teal); }
        .brand-checkbox input:checked + label .brand-name { color: var(--teal); }
        .brand-checkbox label .checkmark { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 5px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .brand-checkbox input:checked + label .checkmark { background: var(--teal); border-color: var(--teal); }
        .brand-checkbox label .checkmark svg { width: 12px; height: 12px; color: white; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .brand-checkbox input:checked + label .checkmark svg { opacity: 1; transform: scale(1); }
        .submit-section { padding: 20px 28px 28px; background: var(--bg-primary); border-top: 1px solid var(--border); }
        .btn-submit { width: 100%; padding: 18px; font-size: 17px; font-weight: 600; font-family: 'DM Sans', sans-serif; color: white; background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%); border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 16px rgba(78, 184, 169, 0.3); }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-submit.loading { color: transparent; position: relative; }
        .btn-submit.loading::after { content: ''; position: absolute; width: 22px; height: 22px; top: 50%; left: 50%; margin: -11px 0 0 -11px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .consent-group { display: flex; align-items: flex-start; gap: 12px; background: var(--plum-pale); padding: 14px; border-radius: 10px; margin-top: 14px; }
        .consent-group input[type="checkbox"] { width: 22px; height: 22px; margin-top: 2px; accent-color: var(--plum); flex-shrink: 0; }
        .consent-group label { font-size: 13px; color: var(--text-primary); cursor: pointer; margin-bottom: 0; text-transform: none; letter-spacing: 0; }
        .success-overlay, .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .success-overlay.show, .modal-overlay.show { opacity: 1; visibility: visible; }
        .success-card { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; margin: 24px; transform: scale(0.9); transition: transform 0.3s; }
        .success-overlay.show .success-card { transform: scale(1); }
        .success-icon { width: 70px; height: 70px; background: var(--teal-pale); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .success-icon svg { width: 35px; height: 35px; color: var(--teal); }
        .success-card h2 { font-family: 'Playfair Display', serif; font-size: 22px; margin-bottom: 10px; color: var(--plum); }
        .success-card p { color: var(--text-secondary); margin-bottom: 6px; font-size: 14px; }
        .email-status { font-size: 12px; padding: 8px 14px; border-radius: 8px; margin: 14px 0; display: inline-block; }
        .email-status.sent { background: var(--teal-pale); color: var(--teal); }
        .email-status.failed { background: #fef2f2; color: var(--error); }
        .btn-new { padding: 14px 28px; font-size: 15px; font-weight: 600; font-family: 'DM Sans', sans-serif; color: white; background: var(--teal); border: none; border-radius: 10px; cursor: pointer; margin-top: 14px; }
        .modal-card { background: white; border-radius: 20px; max-width: 90%; max-height: 80vh; width: 700px; margin: 24px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-header h2 { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--plum); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
        .btn-modal { padding: 10px 20px; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; border-radius: 8px; cursor: pointer; }
        .btn-modal.primary { background: var(--teal); color: white; border: none; }
        .btn-modal.secondary { background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-modal.danger { background: var(--error); color: white; border: none; }
        .data-entry { background: var(--bg-primary); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
        .data-entry-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .data-entry-title { font-weight: 600; font-size: 14px; }
        .data-entry-time { font-size: 11px; color: var(--text-secondary); }
        .data-entry-details { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px; }
        .data-entry-details span { color: var(--text-secondary); }
        .data-entry-brands { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .brand-tag { display: inline-block; background: var(--teal-pale); color: var(--teal); padding: 3px 8px; border-radius: 5px; font-size: 11px; margin: 2px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state svg { width: 40px; height: 40px; margin-bottom: 14px; opacity: 0.5; }
        @media (max-width: 700px) { .brand-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .header { padding: 10px 14px; } .main-content { padding: 14px; } .form-body { padding: 18px; } .form-header { padding: 22px 18px; } .form-header h1 { font-size: 22px; } .logo-text { font-size: 17px; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo-container">
                <div class="logo-circle">dmb</div>
                <div class="logo-text">DM Brands<span>Trade Show Capture</span></div>
            </div>
            <div class="header-actions">
                <div class="capture-count" id="captureCount">0 captured</div>
                <button class="btn-icon" id="viewDataBtn" title="View captured data">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                </button>
                <button class="btn-icon" id="exportBtn" title="Export to CSV">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
            </div>
        </header>
        <main class="main-content">
            <div class="form-card">
                <div class="form-header">
                    <h1>Welcome to DM Brands</h1>
                    <p>Please share your details to receive our catalogues</p>
                </div>
                <form id="captureForm" class="form-body">
                    <div class="form-section">
                        <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Contact Details</h2>
                        <div class="form-row">
                            <div class="form-group"><label>First Name <span class="required">*</span></label><input type="text" name="firstName" id="firstName" placeholder="Enter first name" required autocomplete="off"></div>
                            <div class="form-group"><label>Surname <span class="required">*</span></label><input type="text" name="surname" id="surname" placeholder="Enter surname" required autocomplete="off"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Phone Number</label><input type="tel" name="phone" id="phone" placeholder="Enter phone number" autocomplete="off"></div>
                            <div class="form-group"><label>Email Address <span class="required">*</span></label><input type="email" name="email" id="email" placeholder="Enter email address" required autocomplete="off"></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Business Details</h2>
                        <div class="form-row single"><div class="form-group"><label>Business Name <span class="required">*</span></label><input type="text" name="businessName" id="businessName" placeholder="Enter business name" required autocomplete="off"></div></div>
                        <div class="form-row single"><div class="form-group"><label>Trading Address Line 1 <span class="required">*</span></label><input type="text" name="address1" id="address1" placeholder="Street address" required autocomplete="off"></div></div>
                        <div class="form-row single"><div class="form-group"><label>Trading Address Line 2</label><input type="text" name="address2" id="address2" placeholder="Building, floor, etc. (optional)" autocomplete="off"></div></div>
                        <div class="form-row">
                            <div class="form-group"><label>Town / City <span class="required">*</span></label><input type="text" name="town" id="town" placeholder="Enter town or city" required autocomplete="off"></div>
                            <div class="form-group"><label>Postcode <span class="required">*</span></label><input type="text" name="postcode" id="postcode" placeholder="Enter postcode" required autocomplete="off"></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Catalogue Preferences</h2>
                        <div class="form-row single"><div class="form-group"><label>Catalogue Format <span class="required">*</span></label><select name="catalogueFormat" id="catalogueFormat" required><option value="">Select preferred format</option><option value="digital">Digital (PDF/Email)</option><option value="physical">Physical (Posted)</option><option value="both">Both Digital & Physical</option></select></div></div>
                    </div>
                    <div class="form-section">
                        <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Brands of Interest</h2>
                        <div class="brand-grid">
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="Räder" id="brand-rader"><label for="brand-rader"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">Räder</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="Ideas 4 Seasons" id="brand-ideas"><label for="brand-ideas"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">Ideas 4 Seasons</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="PPD" id="brand-ppd"><label for="brand-ppd"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">PPD</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="Remember" id="brand-remember"><label for="brand-remember"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">Remember</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="Relaxound" id="brand-relaxound"><label for="brand-relaxound"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">Relaxound</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="My Flame Lifestyle" id="brand-myflame"><label for="brand-myflame"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">My Flame</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="Elvang" id="brand-elvang"><label for="brand-elvang"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">Elvang</span></label></div>
                            <div class="brand-checkbox"><input type="checkbox" name="brands" value="GEFU" id="brand-gefu"><label for="brand-gefu"><span class="checkmark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="brand-name">GEFU</span></label></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h2 class="section-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>Additional Notes</h2>
                        <div class="form-row single"><div class="form-group"><label>Notes / Comments</label><textarea name="notes" id="notes" placeholder="Any additional information..."></textarea></div></div>
                        <div class="consent-group"><input type="checkbox" name="consent" id="consent" required><label for="consent">I consent to DM Brands storing my information and contacting me about products and catalogues. We will not share your data with third parties. <span class="required">*</span></label></div>
                    </div>
                </form>
                <div class="submit-section"><button type="submit" class="btn-submit" id="submitBtn">Submit & Send</button></div>
            </div>
        </main>
    </div>
    <div class="success-overlay" id="successOverlay">
        <div class="success-card">
            <div class="success-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
            <h2>Thank You!</h2>
            <p>Your details have been saved.</p>
            <div class="email-status" id="emailStatus"></div>
            <button class="btn-new" id="newEntryBtn">Capture Next Customer</button>
        </div>
    </div>
    <div class="modal-overlay" id="dataModal">
        <div class="modal-card">
            <div class="modal-header"><h2>Captured Data</h2><button class="btn-icon" id="closeModalBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body" id="dataList"></div>
            <div class="modal-footer"><button class="btn-modal danger" id="clearAllBtn">Clear All</button><button class="btn-modal secondary" id="closeModalBtn2">Close</button></div>
        </div>
    </div>
    <script>
        const API_BASE = window.location.origin;
        const STORAGE_KEY = 'dm_brands_captures';
        function getCaptures() { const d = localStorage.getItem(STORAGE_KEY); return d ? JSON.parse(d) : []; }
        function saveCapture(c) { const caps = getCaptures(); caps.push({...c, id: Date.now(), timestamp: new Date().toISOString()}); localStorage.setItem(STORAGE_KEY, JSON.stringify(caps)); updateCount(); }
        function clearAllCaptures() { if (confirm('Delete all captured data? This cannot be undone.')) { localStorage.removeItem(STORAGE_KEY); updateCount(); renderDataList(); } }
        function updateCount() { document.getElementById('captureCount').textContent = getCaptures().length + ' captured'; }

        async function sendToAPI(data) {
            try {
                const response = await fetch(`${API_BASE}/api/public/trade-show-capture`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API request failed');
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        const form = document.getElementById('captureForm');
        const submitBtn = document.getElementById('submitBtn');
        const successOverlay = document.getElementById('successOverlay');
        const emailStatus = document.getElementById('emailStatus');
        
        submitBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const required = form.querySelectorAll('[required]');
            let valid = true;
            required.forEach(f => { if (!f.value || (f.type === 'checkbox' && !f.checked)) { valid = false; f.style.borderColor = 'var(--error)'; f.addEventListener('input', () => f.style.borderColor = '', {once: true}); f.addEventListener('change', () => f.style.borderColor = '', {once: true}); }});
            const brands = form.querySelectorAll('input[name="brands"]:checked');
            if (brands.length === 0) { alert('Please select at least one brand.'); return; }
            if (!valid) { alert('Please fill in all required fields.'); return; }
            
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                surname: document.getElementById('surname').value.trim(),
                phone: document.getElementById('phone').value.trim() || null,
                email: document.getElementById('email').value.trim(),
                businessName: document.getElementById('businessName').value.trim(),
                address1: document.getElementById('address1').value.trim(),
                address2: document.getElementById('address2').value.trim() || null,
                town: document.getElementById('town').value.trim(),
                postcode: document.getElementById('postcode').value.trim().toUpperCase(),
                catalogueFormat: document.getElementById('catalogueFormat').value,
                brands: Array.from(brands).map(b => b.value),
                notes: document.getElementById('notes').value.trim() || null
            };
            
            saveCapture(formData);
            
            let apiResult = null;
            try {
                apiResult = await sendToAPI(formData);
            } catch (error) {
                console.error('Failed to send to API:', error);
            }
            
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            
            if (apiResult && apiResult.emails) {
                if (apiResult.emails.internal_sent && apiResult.emails.customer_sent) {
                    emailStatus.className = 'email-status sent';
                    emailStatus.textContent = '✓ Confirmation emails sent';
                } else if (apiResult.emails.internal_sent || apiResult.emails.customer_sent) {
                    emailStatus.className = 'email-status sent';
                    emailStatus.textContent = '✓ Partial email success';
                } else {
                    emailStatus.className = 'email-status failed';
                    emailStatus.textContent = '⚠ Emails not sent (data saved locally)';
                }
                emailStatus.style.display = 'inline-block';
            } else {
                emailStatus.className = 'email-status failed';
                emailStatus.textContent = '⚠ Offline - data saved locally only';
                emailStatus.style.display = 'inline-block';
            }
            
            successOverlay.classList.add('show');
        });

        document.getElementById('newEntryBtn').addEventListener('click', function() { successOverlay.classList.remove('show'); form.reset(); window.scrollTo(0, 0); document.getElementById('firstName').focus(); });
        document.getElementById('viewDataBtn').addEventListener('click', function() { renderDataList(); document.getElementById('dataModal').classList.add('show'); });
        document.getElementById('closeModalBtn').addEventListener('click', () => document.getElementById('dataModal').classList.remove('show'));
        document.getElementById('closeModalBtn2').addEventListener('click', () => document.getElementById('dataModal').classList.remove('show'));
        document.getElementById('clearAllBtn').addEventListener('click', clearAllCaptures);
        document.getElementById('dataModal').addEventListener('click', function(e) { if (e.target === this) this.classList.remove('show'); });

        function renderDataList() {
            const caps = getCaptures();
            const dl = document.getElementById('dataList');
            if (caps.length === 0) { dl.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>No data captured yet</p></div>'; return; }
            dl.innerHTML = caps.slice().reverse().map(e => {
                const d = new Date(e.timestamp);
                const t = d.toLocaleString('en-GB', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'});
                return '<div class="data-entry"><div class="data-entry-header"><div class="data-entry-title">' + e.firstName + ' ' + e.surname + ' - ' + e.businessName + '</div><div class="data-entry-time">' + t + '</div></div><div class="data-entry-details"><div><span>Email:</span> ' + e.email + '</div><div><span>Phone:</span> ' + (e.phone || 'N/A') + '</div><div><span>Address:</span> ' + e.address1 + ', ' + e.town + ', ' + e.postcode + '</div><div><span>Format:</span> ' + e.catalogueFormat + '</div></div><div class="data-entry-brands">' + e.brands.map(b => '<span class="brand-tag">' + b + '</span>').join('') + '</div>' + (e.notes ? '<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);"><em>Notes: ' + e.notes + '</em></div>' : '') + '</div>';
            }).join('');
        }

        document.getElementById('exportBtn').addEventListener('click', function() {
            const caps = getCaptures();
            if (caps.length === 0) { alert('No data to export.'); return; }
            const headers = ['Timestamp','First Name','Surname','Business Name','Email','Phone','Address Line 1','Address Line 2','Town','Postcode','Catalogue Format','Brands','Notes'];
            const rows = caps.map(e => [e.timestamp, e.firstName, e.surname, e.businessName, e.email, e.phone, e.address1, e.address2, e.town, e.postcode, e.catalogueFormat, e.brands.join('; '), e.notes]);
            const csv = [headers.join(','), ...rows.map(r => r.map(c => '"' + (c || '').replace(/"/g, '""') + '"').join(','))].join('\n');
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'dm-brands-captures-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        });

        updateCount();
    </script>
</body>
</html>